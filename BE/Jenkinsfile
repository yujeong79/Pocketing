pipeline {
    agent any

    options {
        skipDefaultCheckout(false)
    }

    environment {
        BRANCH_NAME = "${env.GIT_BRANCH ?: env.CHANGE_TARGET ?: ''}"
    }

    stages {
        stage('Validate Branch') {
            steps {
                script {
                    if (!BRANCH_NAME.endsWith('develop-BE')) {
                        echo "⛔ 브랜치 '${BRANCH_NAME}'은 develop-BE가 아니므로 빌드를 중단합니다."
                        currentBuild.result = 'SUCCESS'
                        error("STOP: Not develop-BE")
                    } else {
                        echo "✅ 브랜치 '${BRANCH_NAME}'에서 빌드를 계속합니다."
                    }
                }
            }
        }

        stage('Copy Config') {
            steps {
                sh '''
                mkdir -p BE/src/main/resources/
                cp /secret/application.yml BE/src/main/resources/
                cp /secret/application-prod.yml BE/src/main/resources/
                '''
            }
        }

        stage('Build') {
            steps {
                dir('BE') {
                    sh '''
                    chmod +x gradlew
                    ./gradlew clean build -x test
                    '''
                }
            }
        }

        stage('Docker Build & Deploy') {
            steps {
                dir('BE') {
                    sh '''
                    docker stop backend-app || true
                    docker rm backend-app || true
                    docker build -t backend-app .
                    docker run -d --name backend-app -p 8081:8080 backend-app
                    '''
                }
            }
        }
    }
}
