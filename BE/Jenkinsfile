pipeline {
    agent any

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        stage('Copy Config') {
            steps{
                sh 'cp /home/ubuntu/secret/backend/application.yml BE/src/main/resources/'
            }
        }
        stage('Build') {
            steps {
                dir('backend') {
                    sh './gradlew clean build'
                }
            }
        }
        stage('Docker Build & Deploy') {
            steps {
                dir('backend') {
                    sh '''
                    docker build -t backend-app .
                    docker save backend-app | ssh ubuntu@k12a406.p.ssafy.io "docker load"
                    ssh ubuntu@k12a406.p.ssafy.io "docker stop backend-app || true && docker rm backend-app || true"
                    ssh ubuntu@k12a406.p.ssafy.io "docker run -d --name backend-app -p 8081:8080 backend-app"
                    '''
                }
            }
        }
    }
}
